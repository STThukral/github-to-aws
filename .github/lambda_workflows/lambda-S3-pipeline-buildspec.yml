AWSTemplateFormatVersion: '2010-09-09'


Parameters:
  S3Bucket:
    Type: String
    Default: 'my-example-s3-bucket-2025'
  
   GitHubToken:
    Type: String
    NoEcho: true  # Ensures the token is not displayed in CloudFormation logs
    Description: "GitHub OAuth token to access the repository"

Resources:
  # S3 output Bucket
  S3OutputBucket:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: 'my-example-s3-bucket-2025-output'  # Change to your desired bucket name

  # Lambda Execution Role (same as before)
  LambdaExecutionRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Service: 'lambda.amazonaws.com'
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: 'LambdaExecutionPolicy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: 'Allow'
                Action:
                  - 's3:GetObject'
                Resource: '*'

  # Lambda Function (no need for S3 reference here, CodePipeline will handle this)
  CreateLambdaFunction:
    Type: 'AWS::Lambda::Function'
    Properties:
      Handler: 'index.handler'
      Role: !GetAtt LambdaExecutionRole.Arn
      FunctionName: 'MyLambdaFunction'
      Runtime: 'python3.9'  # Replace with your Lambda runtime
      Code:
        # Initially, we won't specify an S3 bucket here, CodePipeline will handle the code upload.
        # So leave this out of the CloudFormation definition for direct GitHub deployment.
        S3Bucket: 'PLACEHOLDER'  # No S3 reference, handled by pipeline
        S3Key: 'PLACEHOLDER'  # No S3 reference, handled by pipeline

  # S3 Bucket
  MyS3Bucket:
    Type: AWS::S3::Bucket
    Properties: 
      BucketName: "my-example-s3-bucket-2025"
      NotificationConfiguration:
        LambdaConfigurations:
          - Event: "s3:ObjectCreated:*"  # Trigger on file creation
            Function: !GetAtt CreateLambdaFunction.Arn
            Filter:
              S3Key:
                Rules:
                  - Name: "suffix"
                    Value: ".csv"  # Optional: Trigger only for .csv files

  # IAM Role for CodePipeline
  CodePipelineRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Service: 'codepipeline.amazonaws.com'
            Action: 'sts:AssumeRole'

  # CodeBuild Project for building Lambda code
  CodeBuildProject:
    Type: 'AWS::CodeBuild::Project'
    Properties:
      Name: 'BuildLambdaFunction'
      Environment:
        ComputeType: 'BUILD_GENERAL1_SMALL'
        Image: 'aws/codebuild/standard:5.0'
        Type: 'LINUX_CONTAINER'
      Source:
        Type: 'CODEPIPELINE'
      Artifacts:
        Type: 'CODEPIPELINE'
      BuildSpec: buildspec.yml # Points to the buildspec.yml in the GitHub repository

 
  # CodePipeline Definition (GitHub as source)
  CodePipeline:
    Type: 'AWS::CodePipeline::Pipeline'
    Properties:
      RoleArn: !GetAtt CodePipelineRole.Arn
      ArtifactStore:
        Type: 'S3'
        Location: !Ref '$S3Bucket'  # Optional: If you want to store pipeline artifacts
      Stages:
        - Name: 'Source'
          Actions:
            - Name: 'GitHub_Source'
              ActionTypeId:
                Category: 'Source'
                Owner: 'ThirdParty'
                Provider: 'GitHub'
                Version: '1'
              OutputArtifacts:
                - Name: 'SourceOutput'
              Configuration:
                Owner: STThukral
                Repo: "https://github.com/STThukral/github-to-aws"  # Correct URL without .git extension
                Branch: "main"  # The branch to use for the pipeline
                OAuthToken: !Ref GitHubToken  # OAuth token for GitHub access

        - Name: 'Build'
          Actions:
            - Name: 'CodeBuild'
              ActionTypeId:
                Category: 'Build'
                Owner: 'AWS'
                Provider: 'CodeBuild'
                Version: '1'
              InputArtifacts:
                - Name: 'SourceOutput'
              OutputArtifacts:
                - Name: 'BuildOutput'
              Configuration:
                ProjectName: !Ref CodeBuildProject
